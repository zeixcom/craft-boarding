{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Tours"|t('boarding') %}
{% set currentSite = craft.app.sites.currentSite %}
{% set sites = craft.app.sites.getAllSites() %}

{% requirePermission 'accessPlugin-boarding' %}

{% block actionButton %}
	<div class="btngroup submit">
		{% if currentUser.can('boarding:createtours') and not tourLimitReached %}
			<a href="{{ url('boarding/tours/new', craft.app.request.getQueryParams()) }}" class="btn submit add icon">{{ "New Tour"|t('boarding') }}</a>
		{% endif %}

		{% if currentUser.can('boarding:createtours') and isProEdition %}
			<a href="{{ url('boarding/tours/import') }}" class="btn" title="{{ 'Import Tours'|t('boarding') }}">
				{{ "Import Tours"|t('boarding') }}
			</a>
		{% endif %}

		{% if tours|length and currentUser.can('boarding:createtours') and isProEdition %}
			<form method="post" class="inline-form export-all-form">
				{{ csrfInput() }}
				{{ actionInput('boarding/export/export-all-tours') }}
				<button type="submit" class="btn" title="{{ 'Export All Tours'|t('boarding') }}" aria-label="{{ 'Export All Tours'|t('boarding') }}">
					{{ "Export All"|t('boarding') }}
				</button>
			</form>
		{% endif %}
	</div>

	{% if craft.app.isMultiSite and isProEdition %}
		<div class="site-selector">
			<div class="btn menubtn" data-icon="world">{{ currentSite.name|t('site') }}</div>
			<div class="menu">
				<ul class="padded">
					{% for siteItem in craft.app.sites.getAllSites() %}
						<li>
							<a href="{{ url('boarding/tours', {site: siteItem.handle}) }}" {% if siteItem.id == currentSite.id %}class="sel"{% endif %}>
								{{ siteItem.name|t('site') }}
							</a>
						</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	{% endif %}
{% endblock %}

{% block content %}
	<div class="boarding-plugin">
	{% if tourLimitReached %}
		<div class="pane" style="margin-bottom: 24px;">
			<div class="readable">
				<blockquote class="note">
					<p>
						<strong>{{ "Tour Limit Reached"|t('boarding') }}</strong><br>
						{{ "You have reached the maximum of {limit} tours allowed in Boarding Lite. Upgrade to Boarding Pro for unlimited tours, plus multi-site support, translations, and import/export features."|t('boarding', {limit: tourLimit}) }}
					</p>
				</blockquote>
			</div>
		</div>
	{% endif %}

	{% if tours|length %}
		<div class="tableview">
			<table class="data fullwidth">
				<thead>
					<tr>
						<th scope="col" class="thin">{{ "Status"|t('app') }}</th>
						{% if isProEdition %}
							<th scope="col" class="thin">{{ "Translatable"|t('app') }}</th>
						{% endif %}
						<th scope="col">{{ "Title"|t('app') }}</th>
						<th scope="col">{{ "User Groups"|t('boarding') }}</th>
						<th scope="col">{{ "Completed By"|t('boarding') }}</th>
						{% if currentUser.can('boarding:edittours') or currentUser.can('boarding:deletetours') %}
							<th scope="col" class="thin">{{ "Actions"|t('app') }}</th>
						{% endif %}
					</tr>
				</thead>
				<tbody>
					{% for tour in tours %}
						<tr data-id="{{ tour.id ?? tour.id }}" data-name="{{ tour.name }}">
							<td class="thin">
								{% set isTourEnabled = tour.enabled == 1 %}
								{% if sites|length > 1 %}
									{% if tour.translations is defined and tour.translations[currentSite.id] is defined %}
										{% set isTourEnabled = tour.translations[currentSite.id].enabled ?? (tour.enabled == 1) %}
									{% else %}
										{% set isTourEnabled = tour.enabled == 1 %}
									{% endif %}
								{% endif %}

								<div class="status {{ isTourEnabled ? 'enabled' : 'disabled' }}"></div>
							</td>
							{% if isProEdition %}
								<td>
									{% if tour.translatable == 1 %}
									<div class="status {{ tour.translatable ? 'enabled' : 'disabled' }}"></div>
									{% else %}
									<div class="status {{ tour.translatable ? 'enabled' : 'disabled' }}"></div>
									{% endif %}
								</td>
							{% endif %}
							<td>
								{% if currentUser.can('boarding:edittours') %}
									<a href="{{ url('boarding/tours/edit/' ~ (tour.id ?? tour.id), {site: currentSite.handle}) }}">{{ tour.name }}</a>
								{% else %}
									<div class="element-label">{{ tour.name }}</div>
								{% endif %}
								{% if tour.description %}
									<div class="element-meta">{{ tour.description }}</div>
								{% endif %}
							</td>
							<td>
								{% set hasUserGroups = tour.userGroups is defined and tour.userGroups is not empty %}
								{% set totalUserGroups = craft.app.userGroups.getAllGroups()|length %}
								{% if hasUserGroups and totalUserGroups != tour.userGroups|length %}
									<div class="pill">
										{% for groupId in tour.userGroups %}
											{% set group = craft.app.userGroups.getGroupById(groupId) %}
											{% if group %}
												<div class="light">{{ group.name }}</div>
											{% else %}
												<div class="light" style="color: red;">Invalid Group: {{ groupId }}</div>
											{% endif %}
										{% endfor %}
									</div>
								{% else %}
									<div class="light">{{ "All user groups"|t('boarding') }}</div>
								{% endif %}
							</td>
							<td>
								{% if tour.completedBy is defined and tour.completedBy|length %}
									<div class="completion-count">
										{{ tour.completedBy|length }}
										{{ "users"|t('boarding') }}
										<div class="completion-details">
											{% for completion in tour.completedBy %}
												<div class="completion-user">
													{{ completion.username }}
													<span class="light">{{ completion.completedAt|date('short') }}</span>
												</div>
											{% endfor %}
										</div>
									</div>
								{% else %}
									<div class="light">{{ "No completions"|t('boarding') }}</div>
								{% endif %}
							</td>

							{% if currentUser.can('boarding:edittours') or currentUser.can('boarding:deletetours') %}
								<td class="thin">
									<div class="btngroup">
										{% if currentUser.can('boarding:createtours') %}
											<form method="post" class="inline-form">
												{{ csrfInput() }}
												{{ actionInput('boarding/tours/duplicate') }}
												{% if not currentSite.primary %}
													{{ redirectInput('boarding/tours?site=' ~ currentSite.handle) }}
												{% else %}
													{{ redirectInput('boarding/tours') }}
												{% endif %}

												{{ hiddenInput('id', tour.id) }}
												<button type="submit" class="btn small" title="{{ 'Duplicate'|t('boarding') }}" aria-label="{{ 'Duplicate'|t('boarding') }}">{{ 'Duplicate'|t('boarding') }}</button>
											</form>
										{% endif %}
										
										{% if tour and tour.enabled %}
										<a href="{{ url('admin/dashboard', { startTour: tour.tourId }) }}" class="btn small" target="_blank" >{{ "Preview"|t('boarding') }}</a>
										{% endif %}

										{# Export single tour button #}
										{% if currentUser.can('boarding:createtours') and isProEdition %}
											<form method="post" class="inline-form export-form">
												{{ csrfInput() }}
												{{ actionInput('boarding/export/export-tour') }}
												{{ hiddenInput('id', tour.id) }}
												<button type="submit" class="btn small" title="{{ 'Export Tour'|t('boarding') }}" aria-label="{{ 'Export Tour'|t('boarding') }}">
													<svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
														<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
														<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
													</svg>
												</button>
											</form>
										{% endif %}

										{% if currentUser.can('boarding:deletetours') %}
											<form method="post" class="inline-form delete-form">
												{{ csrfInput() }}
												{{ actionInput('boarding/tours/delete') }}
												{% if not currentSite.primary %}
													{{ redirectInput('boarding/tours?site=' ~ currentSite.handle) }}
												{% else %}
													{{ redirectInput('boarding/tours') }}
												{% endif %}
												{{ hiddenInput('id', tour.id) }}
												<button type="button" class="btn submit bg-red small delete-btn" title="{{ 'Delete'|t('app') }}" aria-label="{{ 'Delete'|t('app') }}">{{ 'Delete'|t('app') }}</button>
											</form>
										{% endif %}
									</div>
								</td>
							{% endif %}
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% else %}
		<div id="no-tours">
			<p>{{ "No tours created yet."|t('boarding') }}</p>
		</div>
	{% endif %}
	</div>
{% endblock %}

{% js %}
$(document).ready(function() {
	$('.delete-btn').on('click', function(e) {
		e.preventDefault();
		var $btn = $(this);
		var $form = $btn.closest('form.delete-form');
		var tourName = $form.closest('tr').data('name');
		
		if (confirm('Are you sure you want to delete the tour "' + tourName + '"?')) {
			var data = $form.serialize();
			
			Craft.postActionRequest($form.find('input[name="action"]').val(), data, function(response) {
				if (response && response.success) {
					window.location.reload();
				} else {
					Craft.cp.displayError('Could not delete tour.');
				}
			});
		}
	});
});
{% endjs %}
