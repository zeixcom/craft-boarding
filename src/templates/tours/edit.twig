{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}
{% import "boarding/_macros/tour-edit.twig" as tourMacros %}

{% set tour = tour is defined ? tour : null %}
{% set title = tour ? "#{tour.title}"|t('boarding') : "Create New Tour"|t('boarding') %}
{% set pageTitle = tour ? "Edit Tour: #{tour.title}"|t('boarding') : "Create New Tour"|t('boarding') %}
{% set currentSite = craft.app.sites.currentSite %}
{% set sites = craft.app.sites.getAllSites() %}
{% set primarySite = craft.app.sites.primarySite %}
{% set isProEdition = craft.app.plugins.isPluginEnabled('boarding') and craft.app.plugins.getPlugin('boarding').edition == 'pro' %}

{% do view.registerAssetBundle("zeix\\boarding\\assetbundles\\BoardingAsset") %}

{% requirePermission 'accessPlugin-boarding' %}
{% if tour %}
	{% requirePermission 'boarding:edittours' %}
{% else %}
	{% requirePermission 'boarding:createtours' %}
{% endif %}

{% block actionButton %}
	{% if craft.app.isMultiSite and isProEdition and availableSites|length > 1 %}
        <div class="site-selector">
            <div class="btn menubtn" data-icon="world">{{ currentSite.name|t('site') }}</div>
            <div class="menu">
                <ul class="padded">
                    {% for siteItem in availableSites %}
                        <li>
                            <a href="{{ url('boarding/tours/edit/' ~ (tour.id ?? 'new'), {site: siteItem.handle}) }}" {% if siteItem.id == currentSite.id %}class="sel"{% endif %}>
                                {{ siteItem.name|t('site') }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}


{% block content %}	
	<div id="boarding-tour-edit" class="boarding-plugin" 
		data-is-new="{{ tour ? 'false' : 'true' }}"
		data-primary-site-id="{{ primarySite.id }}">
		<form method="post" accept-charset="UTF-8" data-saveshortcut data-validate id="tour-edit-form">
			{{ csrfInput() }}
			{{ actionInput('boarding/tours/save') }}
			{{ redirectInput('boarding/tours') }}
			
			{% if tour and tour.id %}
				{{ hiddenInput('id', tour.id) }}
			{% endif %}
            
            {{ hiddenInput('siteId', currentSite.id) }}

			<div class="field-layout">
				<div class="field-layout-column">
					{{ forms.lightswitchField({
						label: "Enabled"|t('app'),
						id: 'enabled',
						name: 'enabled',
						on: tour ? tour.enabled : true,
						first: true
					}) }}

				{% if sites|length > 1 and isProEdition %}
					{{ forms.selectField({
						label: "Propagation Method"|t('app'),
						instructions: "Choose which sites this tour should be saved to"|t('boarding'),
						id: 'propagationMethod',
						name: 'propagationMethod',
						value: tour ? tour.propagationMethod : 'none',
						options: {
							'none': {
								label: 'Save it to the {site} site only'|t('boarding', {site: currentSite.name}),
							},
							'all': {
								label: 'Save it to all sites'|t('boarding'),
								info: 'The same tour content will be used for all sites'|t('boarding')
							},
						'siteGroup': {
							label: 'Save it to all sites in this site group'|t('boarding'),
							info: 'Each site in the group can have its own version of this tour'|t('boarding')
						},
							'language': {
								label: 'Save it to sites with the same language'|t('boarding'),
								info: 'Only sites using the {language} language'|t('boarding', {language: currentSite.language})
							}
						},
						errors: tour ? tour.getErrors('propagationMethod') : null
					}) }}
				{% endif %}

					{{ forms.textField({
						label: "Name"|t('boarding'),
						id: 'name',
						name: 'name',
						value: tour ? tour.title : '',
						required: true,
						errors: tour ? tour.getErrors('name') : null,
						class: 'fullwidth'
					}) }}

					{{ forms.textareaField({
						label: "Description"|t('boarding'),
						id: 'description',
						name: 'description',
						value: tour ? tour.description : '',
						class: 'nicetext fullwidth',
						rows: 3
					}) }}

					<hr>

					{{ forms.selectField({
						label: "Progress Indicator Position"|t('boarding'),
						instructions: "Where to display the progress indicator (step count)"|t('boarding'),
						id: 'progressPosition',
						name: 'progressPosition',
						options: {
							'off': 'Off '|t('boarding'),
							'header': 'Step Header'|t('boarding'),
							'footer': 'Step Footer'|t('boarding')
						},
						value: tour ? tour.progressPosition : 'off'
					}) }}

					{{ forms.lightswitchField({
						label: "Autoplay"|t('boarding'),
						instructions: "Automatically start this tour for users who haven't completed it yet."|t('boarding'),
						id: 'autoplay',
						name: 'autoplay',
						on: tour ? tour.autoplay : false,
						errors: tour ? tour.getErrors('autoplay') : null
					}) }}

					<hr>
										
					{{ forms.checkboxGroupField({
						label: "User Groups"|t('boarding'),
						instructions: "Select which user groups can access this tour"|t('boarding'),
						id: "userGroupIds",
						name: "userGroupIds",
						options: craft.app.userGroups.getAllGroups()|map(g => {
							label: g.name,
							value: g.id|string
						}),
						values: tour ? tour.userGroups|map(v => v|string) : [],
					}) }}

					<div class="field">
						<div class="heading">
							<label class="required">{{ "Steps"|t('boarding') }}</label>
						</div>

						<div id="tour-steps" class="grid">
							{% set steps = tour and tour.steps ? tour.steps : [{}] %}
							{% for step in steps %}
								<div class="tour-step card">
										<div class="card-header">
											<h4>Step {{ loop.index }}</h4>
											<div class="card-actions">
												<div class="move icon" title="{{ 'Reorder'|t('app') }}"></div>
												<button type="button" class="btn small icon js-add-step-above" title="{{ 'Add step above'|t('boarding') }}">
													<span data-icon="minus"></span>
												</button>
												<button type="button" class="btn small icon js-add-step-below" title="{{ 'Add step below'|t('boarding') }}">
													<span data-icon="plus"></span>
												</button>
												<button type="button" class="btn small icon delete js-delete-step" title="{{ 'Delete step'|t('boarding') }}"></button>
											</div>
										</div>
										<div class="card-body">
											{% set stepIndex = loop.index0 %}
											
											<div class="field">
												<div class="heading">
													<label class="required">{{ "Title"|t('boarding') }}</label>
												</div>
												<div class="input">
													{{ tourMacros.stepTranslationField('title', stepIndex, step, currentSite, sites, primarySite) }}
												</div>
											</div>

											<div class="field">
												<div class="heading">
													<label class="required">{{ "Content"|t('boarding') }}</label>
													<div class="instructions">{{ "The content that will be shown to users in this step"|t('boarding') }}</div>
												</div>
												<div class="input">
													{{ tourMacros.stepTranslationTextarea('text', stepIndex, step, currentSite, sites, primarySite, 3) }}
												</div>
											</div>

											<div class="field">
												<div class="heading">
													<label>{{ "Step Type"|t('boarding') }}</label>
													<div class="instructions">{{ "Choose whether this is a regular step or a navigation step"|t('boarding') }}</div>
												</div>
												
												<div class="input">
													<div class="select">
														<select class="select" name="steps[{{ stepIndex }}][type]">
															<option value="default" {{ (step.type ?? 'default') == 'default' ? 'selected' : '' }}>{{ "Default Step"|t('boarding') }}</option>
															<option value="navigation" {{ (step.type ?? 'default') == 'navigation' ? 'selected' : '' }}>{{ "Navigation Step"|t('boarding') }}</option>
														</select>
													</div>
												</div>
											</div>

											<div class="navigation-fields {% if (step.type ?? 'default') == 'navigation' %}visible{% else %}hidden{% endif %}">
												<div class="field">
													<div class="heading">
														<label>{{ "Navigation URL"|t('boarding') }}</label>
														<div class="instructions">{{ "The URL to navigate to (e.g., /admin/assets)"|t('boarding') }}</div>
													</div>
													<div class="input">
														<input class="text fullwidth" type="text" name="steps[{{ stepIndex }}][navigationUrl]" value="{{ step.navigationUrl ?? '' }}">
													</div>
												</div>
												<div class="field">
													<div class="heading">
														<label>{{ "Navigation Button Text"|t('boarding') }}</label>
														<div class="instructions">{{ "The text to display on the navigation button"|t('boarding') }}</div>
													</div>
													<div class="input">
														{{ tourMacros.stepTranslationField('navigationButtonText', stepIndex, step, currentSite, sites, primarySite, false) }}
													</div>
												</div>
											</div>

											<div class="field">
												<div class="heading">
													<label>{{ "Target Element"|t('boarding') }}</label>
													<div class="instructions">{{ "CSS selector for the target element (e.g. #nav-dashboard)"|t('boarding') }}</div>
												</div>
												<div class="input">
													<input class="text fullwidth" type="text" name="steps[{{ stepIndex }}][attachTo][element]" value="{{ (step.attachTo ?? {}).element ?? '' }}">
												</div>
											</div>

											<div class="field">
												<div class="heading">
													<label>{{ "Placement"|t('boarding') }}</label>
													<div class="instructions">{{ "Where the step should appear relative to the target element"|t('boarding') }}</div>
												</div>
												<div class="input ltr">
													<div class="select">
														<select class="select" name="steps[{{ stepIndex }}][attachTo][on]">
															<option value="top" {{ ((step.attachTo ?? {}).on ?? 'bottom') == 'top' ? 'selected' : '' }}>{{ "Top"|t('boarding') }}</option>
															<option value="bottom" {{ ((step.attachTo ?? {}).on ?? 'bottom') == 'bottom' ? 'selected' : '' }}>{{ "Bottom"|t('boarding') }}</option>
															<option value="left" {{ ((step.attachTo ?? {}).on ?? 'bottom') == 'left' ? 'selected' : '' }}>{{ "Left"|t('boarding') }}</option>
															<option value="right" {{ ((step.attachTo ?? {}).on ?? 'bottom') == 'right' ? 'selected' : '' }}>{{ "Right"|t('boarding') }}</option>
														</select>
													</div>
												</div>
											</div>

										</div>
									</div>
								{% endfor %}
						</div>

						<div class="buttons">
							<button type="button" class="btn add icon js-add-step">
								{{ "Add Step"|t('boarding') }}
							</button>
						</div>
					</div>
				</div>
			</div>

			<div class="tour-validation-error alert error" style="display: none;">
				{{ "A tour must have at least one step defined."|t('boarding') }}
			</div>

			<div class="buttons">
				<button type="submit" class="btn submit">{{ "Save"|t('boarding') }}</button>

				{% if tour and tour.tourId %}
					<a href="{{ url('admin/dashboard', { startTour: tour.tourId }) }}" class="btn" target="_blank">{{ "Preview"|t('boarding') }}</a>
				{% endif %}
			</div>
		</form>
	</div>
{% endblock %}